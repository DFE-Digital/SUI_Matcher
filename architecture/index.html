
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../adrs/" rel="prev"/>
<link href="../cicd/" rel="next"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.7" name="generator"/>
<title>Architecture - NHS Number Matcher</title>
<link href="../assets/stylesheets/main.8608ea7d.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../assets/_mkdocstrings.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#architecture">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="NHS Number Matcher" class="md-header__button md-logo" data-md-component="logo" href=".." title="NHS Number Matcher">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            NHS Number Matcher
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Architecture
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="NHS Number Matcher" class="md-nav__button md-logo" data-md-component="logo" href=".." title="NHS Number Matcher">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    NHS Number Matcher
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    Introduction
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../adrs/">
<span class="md-ellipsis">
    Architecture Decision Records
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Architecture
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Architecture
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#constraints-and-principals">
<span class="md-ellipsis">
      Constraints and Principals
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#high-level-logical-architecture">
<span class="md-ellipsis">
      High Level Logical Architecture
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#systems-architecture">
<span class="md-ellipsis">
      Systems Architecture
    </span>
</a>
<nav aria-label="Systems Architecture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#physical-view">
<span class="md-ellipsis">
      Physical View
    </span>
</a>
<nav aria-label="Physical View" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#definitions">
<span class="md-ellipsis">
      Definitions
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-by-step-flow-happy-path">
<span class="md-ellipsis">
      Step by Step Flow Happy Path
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sequence-diagram">
<span class="md-ellipsis">
      Sequence Diagram
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#application-architecture">
<span class="md-ellipsis">
      Application Architecture
    </span>
</a>
<nav aria-label="Application Architecture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#container-diagram">
<span class="md-ellipsis">
      Container diagram
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#services">
<span class="md-ellipsis">
      Services
    </span>
</a>
<nav aria-label="Services" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#matching">
<span class="md-ellipsis">
      matching
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#auth">
<span class="md-ellipsis">
      auth
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#external">
<span class="md-ellipsis">
      external
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#search-criteria">
<span class="md-ellipsis">
      Search Criteria
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-overview">
<span class="md-ellipsis">
      Data Overview
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#non-functional-requirements">
<span class="md-ellipsis">
      Non Functional Requirements
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#non-functional-priorities">
<span class="md-ellipsis">
      Non Functional Priorities
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cicd/">
<span class="md-ellipsis">
    CI/CD
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../clientarchitecture/">
<span class="md-ellipsis">
    Client Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../gettingstarted/">
<span class="md-ellipsis">
    Getting started
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../waysof/">
<span class="md-ellipsis">
    Ways of Working
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
<span class="md-ellipsis">
    Strategies
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_8_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
            Strategies
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../strategies/rules/">
<span class="md-ellipsis">
    Rule Definitions
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../strategies/strategies/">
<span class="md-ellipsis">
    Strategies
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../strategies/strategy3/">
<span class="md-ellipsis">
    Strategy 3 Full Version History
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#constraints-and-principals">
<span class="md-ellipsis">
      Constraints and Principals
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#high-level-logical-architecture">
<span class="md-ellipsis">
      High Level Logical Architecture
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#systems-architecture">
<span class="md-ellipsis">
      Systems Architecture
    </span>
</a>
<nav aria-label="Systems Architecture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#physical-view">
<span class="md-ellipsis">
      Physical View
    </span>
</a>
<nav aria-label="Physical View" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#definitions">
<span class="md-ellipsis">
      Definitions
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-by-step-flow-happy-path">
<span class="md-ellipsis">
      Step by Step Flow Happy Path
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sequence-diagram">
<span class="md-ellipsis">
      Sequence Diagram
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#application-architecture">
<span class="md-ellipsis">
      Application Architecture
    </span>
</a>
<nav aria-label="Application Architecture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#container-diagram">
<span class="md-ellipsis">
      Container diagram
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#services">
<span class="md-ellipsis">
      Services
    </span>
</a>
<nav aria-label="Services" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#matching">
<span class="md-ellipsis">
      matching
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#auth">
<span class="md-ellipsis">
      auth
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#external">
<span class="md-ellipsis">
      external
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#search-criteria">
<span class="md-ellipsis">
      Search Criteria
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#data-overview">
<span class="md-ellipsis">
      Data Overview
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#non-functional-requirements">
<span class="md-ellipsis">
      Non Functional Requirements
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#non-functional-priorities">
<span class="md-ellipsis">
      Non Functional Priorities
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="architecture">Architecture</h1>
<p>These are the architecture documents.</p>
<h2 id="constraints-and-principals">Constraints and Principals</h2>
<p>This project is aimed at providing a solution for Local Authorities that require more accurate matching capabilities.</p>
<p>It requires a use-case to be agreed with NHS England to allow the use of the PDS FHIR API. This will require a number of
governance steps to be followed, such as
the <a href="https://transform.england.nhs.uk/key-tools-and-info/digital-technology-assessment-criteria-dtac/">DTAC</a>.</p>
<p>The PDS FHIR API has a limitation of 5 transactions per second for requests, and the "fallback" logic used in the pilot
means each match to a person may use greater than 1 request. This means the PDS FHIR API is expected to initially be the
biggest bottleneck for performance.</p>
<p>For principles, please refer to
the <a href="https://technical-guidance.education.gov.uk/principles/general/">DfE Technical Guidance</a>
and <a href="https://www.security.gov.uk/policy-and-guidance/secure-by-design/">Secure by Design Principles</a>.</p>
<h2 id="high-level-logical-architecture">High Level Logical Architecture</h2>
<pre class="mermaid"><code>C4Container
    title High Level Components - NHS SUI
    Container_Boundary(c1, "Local Authority") {
        System(laclient, "Local Authority Client")
        System(sui_matching_service, "Sui Matching Service")
        ContainerDb(db, "File Storage", "Liquid Logic Output")
    }
    Container_Boundary(c2, "NHS Services") {
        System(nhs_fhir_api, "NHS PDS FHIR API")
        System(nhs_auth_api, "NHS PDS Auth API")
    }

    Rel(laclient, db, "Gets File")
    Rel(laclient, sui_matching_service, "HTTPS")
    Rel(sui_matching_service, nhs_fhir_api, "HTTPS")
    Rel(sui_matching_service, nhs_auth_api, "HTTPS")
</code></pre>
<h2 id="systems-architecture">Systems Architecture</h2>
<h3 id="physical-view">Physical View</h3>
<p><img alt='"System architecture drawing in drawio"' src="../assets/SUI-systems-arch.drawio.png"/></p>
<h4 id="definitions">Definitions</h4>
<p><strong>Liquid Logic Server (Local Authority owned and run):</strong>
Case management system used for recording referrals. Contains records with demographic information about referrals.</p>
<p><strong>File Storage (Local Authority owned and run):</strong>
Server that will contain the file with the source information.</p>
<p><strong>Client Tool (New Component):</strong>
A tool that takes the input file from the file storage and loops through the rows of data making a request to the SUI
matching service. It outputs a results of the matching process and extra information about it.</p>
<p><strong>SUI Resource Group (New Component):</strong>
Represents the application that will be deployed in a Local Authority.</p>
<h4 id="step-by-step-flow-happy-path">Step by Step Flow Happy Path</h4>
<ol>
<li>A nightly batch job runs that outputs a CSV file to an accessible location.</li>
<li>The client tool periodically checks for a new file.</li>
<li>When a new file is present it consumes it and starts to process the data.</li>
<li>The client loops through the records in the file and extracts the information needed to be able to make an API call
   against the SUI Matching Service via a private endpoint.</li>
<li>The SUI Matching Service ingress controller (reverse proxy) accepts the request and forwards it onto the service.</li>
<li>The SUI Service validates the data.</li>
<li>With valid data it then checks authentication is in place to make a request to the NHS.</li>
<li>With valid data and a valid authentication token it then makes one or more calls to the NHS PDS FHIR API to retrieve
   a NHS number. This call is made over the internet.</li>
<li>The returned results are examined and then returned to the client.</li>
<li>The client outputs the data to a results CSV file (NHS numbers alongside the data) and a metadata CSV file that
    gives further information on the process and input data.</li>
</ol>
<h3 id="sequence-diagram">Sequence Diagram</h3>
<pre class="mermaid"><code>sequenceDiagram
    box Client Tooling
        participant client as Client Tool
    end
    box SUI Service
        participant suimatch as SUI Matching Service
        participant suiexternal as SUI External Service
        participant suiauth as SUI Auth Service
    end
    box NHS Services
        participant nhsauth as NHS AUTH API
        participant nhssearch as NHS FHIR API
    end

    client -&gt;&gt;+ suimatch: Sends record to be validated and matched
    loop Validate Data
        suimatch -&gt;&gt; suimatch: Validate the data sent
        alt Invalid Data
            suimatch --&gt;&gt; client: Data invalid end process
        else Valid Data
            suimatch -&gt;&gt;+ suiexternal: Sends query so a request can be made
        end
    end
    suiexternal -&gt;&gt;+ suiauth: Checks authentication status
    alt Token Does Not Exist
        suiauth -&gt;&gt; nhsauth: Get new token
        nhsauth --&gt;&gt; suiauth: Return new token
    else Token Exists
        suiauth --&gt;&gt; suiexternal: Token available to return
    end
    suiexternal -&gt;&gt; nhssearch: Makes request to NHS service
    nhssearch --&gt;&gt; suiexternal: Returns data
    suiexternal --&gt;&gt;- suimatch: Passes response to be formatted
    suimatch --&gt;&gt;- client: Returns data to client to be output

</code></pre>
<h2 id="application-architecture">Application Architecture</h2>
<h3 id="container-diagram">Container diagram</h3>
<pre class="mermaid"><code>C4Container
    title Container diagram for SUI Matcher
    System(laclient, "Local Authority Client", "The client to connect to the service")

    Container_Boundary(c1, "Sui Matching Service") {
        Container(reverse_proxy, "Gateway", "C#, .NET 8, YARP", "The reverse proxy/API gateway of the SUI matcher.")
        Container(matching_api, "Matching APIs", "C#, .NET 8, MassTransit", "The barista service.")
        Container(auth_api, "Auth APIs", "C#, .NET 8, MassTransit", "The authentication service.")
        Container(external_api, "External Services", "C#, .NET 8, Marten", "Makes the outbound connections for other services")

        Boundary(b1, "Docker containers", "boundary") {
            ContainerDb(cache, "Storage", "Redis", "Stores bearer tokens for auth")
            Container(keyvault, "KeyVault", "Azure Key Vault", "Storage of secret values")
        }
    }
    Container_Boundary(c2, "NHS PDS FHIR API") {
        System(pds, "PDS FHIR API", "The PDS service")
    }

    Rel(laclient, reverse_proxy, "Uses", "HTTPS")
    UpdateRelStyle(laclient, reverse_proxy, $offsetY="-20")
    Rel(reverse_proxy, matching_api, "Proxies", "HTTP")
    Rel(auth_api, cache, "Adds/checks Tokens", "HTTP")
    Rel(auth_api, keyvault, "Gets Secrets", "HTTP")
    Rel(auth_api, pds, "Authenticates", "HTTPS")
    UpdateRelStyle(auth_api, cache, $offsetX="30")
    Rel(external_api, cache, "Gets Token", "HTTP")
    Rel(external_api, keyvault, "Gets Secrets", "HTTP")
    Rel(external_api, pds, "Retrieves NHS Number", "HTTPS")
    UpdateRelStyle(external_api, keyvault, $offsetX="40", $offsetY="40")
    Rel(external_api, auth_api, "Calls", "HTTP")
    Rel(matching_api, external_api, "Calls", "HTTP")

</code></pre>
<h3 id="services">Services</h3>
<h4 id="matching">matching</h4>
<p>The matching service provides the ingress into the application. It also serves as the logic controller for the
application. It accepts the following parameters:</p>
<ul>
<li>given name (required)</li>
<li>family name (required)</li>
<li>date of birth - which can be a range (required)</li>
<li>gender</li>
<li>postcode</li>
<li>email address</li>
<li>phone number</li>
</ul>
<p>Adapted from the schema specified here
<a href="https://digital.nhs.uk/developer/api-catalogue/personal-demographics-service-fhir#get-/Patient">NHS PDS FHIR Schema</a>.</p>
<p>It validates these parameters meet the schema and then handles the logic for making external calls to the NHS in order
to find a matching NHS number.</p>
<p>Response 200:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"> </span>
<span class="w">    </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">"matchStatus"</span><span class="p">:</span><span class="w"> </span><span class="s2">"match"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"nhsNumber"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1234567890"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"processStage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"score"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.96"</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">"dataQuality"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">"given"</span><span class="p">:</span><span class="w"> </span><span class="s2">"valid"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"family"</span><span class="p">:</span><span class="w"> </span><span class="s2">"valid"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"birthdate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"valid"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"addressPostalCode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"valid"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"phone"</span><span class="p">:</span><span class="w"> </span><span class="s2">"invalid"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"invalid"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"notProvided"</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Result</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Desc</th>
<th style="text-align: left;">Values</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">matchStatus</td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">Match Result</td>
<td style="text-align: left;">See <em>Match Status</em> table below.</td>
</tr>
<tr>
<td style="text-align: left;">nhsNumber</td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">nhsNumnber</td>
<td style="text-align: left;">10 digit string, empty string</td>
</tr>
<tr>
<td style="text-align: left;">ProcessStage</td>
<td style="text-align: left;">int</td>
<td style="text-align: left;">stage of the process it exited at</td>
<td style="text-align: left;">0, 1, 2, 3</td>
</tr>
<tr>
<td style="text-align: left;">score</td>
<td style="text-align: left;">number</td>
<td style="text-align: left;">Score of the search</td>
<td style="text-align: left;">0.0 to 1.0</td>
</tr>
</tbody>
</table>
<p><strong>Match Status</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;">Name</th>
<th style="text-align: left;">Desc</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">match</td>
<td style="text-align: left;">One match has been returned</td>
</tr>
<tr>
<td style="text-align: left;">noMatch</td>
<td style="text-align: left;">No match has been returned</td>
</tr>
<tr>
<td style="text-align: left;">potentialMatch</td>
<td style="text-align: left;">There is a potential match. One match with score above 0.85 and below 0.95</td>
</tr>
<tr>
<td style="text-align: left;">lowConfidenceMatch</td>
<td style="text-align: left;">There is a low confidence match. One match with score but is below 0.85</td>
</tr>
<tr>
<td style="text-align: left;">manyMatch</td>
<td style="text-align: left;">System returns mulitple matches</td>
</tr>
</tbody>
</table>
<p><strong>Data quality</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;">Return</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Desc</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Valid</td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">Data provided is valid</td>
</tr>
<tr>
<td style="text-align: left;">Invalid</td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">Data provided is invalid</td>
</tr>
<tr>
<td style="text-align: left;">notProvided</td>
<td style="text-align: left;">string</td>
<td style="text-align: left;">No data was provided</td>
</tr>
</tbody>
</table>
<h4 id="auth">auth</h4>
<p>Handles the secret key material in order to get the bearer token. It will use azure Key Vault to get the material needed
to retrieve the bearer token. It will then store the bearer token in Redis to be accessed by the external service.</p>
<h4 id="external">external</h4>
<p>Makes the external calls to the NHS PDS endpoints. Will get secrets from Key vault and bearer token from Redis.</p>
<h3 id="search-criteria">Search Criteria</h3>
<p>Below there is reference to scoring. This scoring is the confidence score that is returned by the NHS when we perform a
search. More information can be found about that in the scoring section
here: <a href="https://digital.nhs.uk/developer/api-catalogue/personal-demographics-service-fhir#get-/Patient">PDS FHIR Search</a></p>
<pre class="mermaid"><code>---
title: Matching conditions flow
---
stateDiagram-v2
    clean: Canonicalise/clean data
    apply_match_conditions: Apply Match Conditions
    if_single_match: Single Match found
    if_no_match_state: No Match found
    confirmed_match: Confirmed Match
    potential_match: Potential Match
    low_confidence_match: Low Confidence Match
    no_match: no match
    manual_process: Manual Process
    multiple_match: Multiple Matches
    [*] --&gt; clean
    clean --&gt; apply_match_conditions
    apply_match_conditions --&gt; if_single_match
    apply_match_conditions --&gt; multiple_match
    multiple_match --&gt; manual_process: No NHS number
    if_single_match --&gt; confirmed_match: if &gt;= 95% confident
    if_single_match --&gt; potential_match: if &lt; 95% and &gt;= 85% confident
    if_single_match --&gt; low_confidence_match: if &lt; 85% confident
    confirmed_match --&gt; [*]: has NHS number
    potential_match --&gt; manual_process: has NHS number
    low_confidence_match --&gt; manual_process: has NHS number
    apply_match_conditions --&gt; if_no_match_state
    if_no_match_state --&gt; apply_match_conditions: if more match conditions
    if_no_match_state --&gt; no_match: if no more match conditions
    no_match --&gt; manual_process: No NHS number
    manual_process --&gt; [*]

</code></pre>
<h2 id="data-overview">Data Overview</h2>
<p>This section is a work in progress...</p>
<p>This project will collect anonymous data about the process. For each record that is sent to the service we will record
information on the following:</p>
<ul>
<li>Data Quality</li>
<li>Match Result</li>
<li>Match Result Process Info</li>
<li>Age Range</li>
</ul>
<p>This will allow for aggregate information to be collated and an evaluation on the process overall to be viewed.</p>
<p>This information will be collated via log messages.</p>
<p>No PII will be recorded.</p>
<h2 id="non-functional-requirements">Non Functional Requirements</h2>
<p>Placeholder</p>
<h2 id="non-functional-priorities">Non Functional Priorities</h2>
<p>The Non-Functional Priorities for the pilot are listed below.</p>
<ol>
<li><strong>Security</strong> - Very sensitive data must be protected.</li>
<li><strong>Usability</strong> - Easy for both internal teams and external partners (e.g., Local Authorities) to use and adopt.</li>
<li><strong>Compatibility</strong> - Integration with existing systems like the NHS and Local Authority ecosystems.</li>
<li><strong>Maintainability</strong> - Highly iterative development process anticipated.</li>
<li><strong>Reliability</strong> - Not initially business-critical. Reliable enough for the pilot phase.</li>
<li><strong>Performance</strong> - Handling relatively small workloads during the pilot phase.</li>
<li><strong>Availability</strong> - Emphasis on maintenance and ensuring sufficient uptime.</li>
<li><strong>Portability</strong> - Targeted at limited settings for the pilot.</li>
<li><strong>Scalability</strong> - May scale from 1 to 4 Local Authorities (LAs) quickly, this would require these priorities to
   change. Future hosting patterns to be reviewed.</li>
</ol>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>